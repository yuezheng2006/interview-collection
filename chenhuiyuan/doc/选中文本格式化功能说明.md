# 选中文本格式化功能说明

## 功能概述

实现了真正的选中文本格式化功能，用户可以选中特定文本并应用加粗、斜体、下划线等样式，而不是修改整个编辑器的样式。

## 核心特性

### 1. 选择性格式化
- 只对用户选中的文本应用格式
- 未选中的文本保持原样
- 支持精确的文本范围控制

### 2. 智能标签管理
- 自动检测已存在的HTML标签
- 避免重复添加相同标签
- 支持标签的添加和移除

### 3. 光标位置保持
- 格式化后自动更新选择范围
- 保持用户的操作连续性
- 自动聚焦到文本框

## 技术实现

### 核心函数

#### `applyFormatting(formatType)`
```typescript
function applyFormatting(formatType: 'bold' | 'italic' | 'underline' | 'clear') {
  // 1. 获取选中文本范围
  // 2. 根据格式类型处理文本
  // 3. 替换原文本
  // 4. 更新选择范围
  // 5. 保持光标位置
}
```

#### 格式类型处理逻辑

**加粗 (bold)**
```typescript
case 'bold':
  if (selectedText.startsWith('<strong>') && selectedText.endsWith('</strong>')) {
    // 移除加粗标签
    formattedText = selectedText.slice(8, -9)
  } else {
    // 添加加粗标签
    formattedText = `<strong>${selectedText}</strong>`
  }
  break
```

**斜体 (italic)**
```typescript
case 'italic':
  if (selectedText.startsWith('<em>') && selectedText.endsWith('</em>')) {
    // 移除斜体标签
    formattedText = selectedText.slice(4, -5)
  } else {
    // 添加斜体标签
    formattedText = `<em>${selectedText}</em>`
  }
  break
```

**下划线 (underline)**
```typescript
case 'underline':
  if (selectedText.startsWith('<u>') && selectedText.endsWith('</u>')) {
    // 移除下划线标签
    formattedText = selectedText.slice(3, -4)
  } else {
    // 添加下划线标签
    formattedText = `<u>${selectedText}</u>`
  }
  break
```

**清除格式 (clear)**
```typescript
case 'clear':
  // 使用正则表达式清除所有HTML标签
  formattedText = selectedText.replace(/<\/?(strong|em|u|b|i)>/g, '')
  break
```

### 选择范围管理

```typescript
// 获取当前选择范围
let start = selectionStart.value
let end = selectionEnd.value

// 验证选择范围
if (start < 0) start = 0
if (end > text.length) end = text.length
if (start >= end) return

// 更新选择范围
const newStart = start
const newEnd = start + formattedText.length

// 使用nextTick确保DOM更新后再设置选择范围
nextTick(() => {
  if (textarea) {
    textarea.setSelectionRange(newStart, newEnd)
    selectionStart.value = newStart
    selectionEnd.value = newEnd
    cursorPosition.value = newEnd
    textarea.focus()
  }
})
```

## 用户交互流程

### 1. 选择文本
- 用户使用鼠标或键盘选择要格式化的文本
- 系统自动记录选择范围（start, end）

### 2. 应用格式
- 用户点击格式化按钮（加粗、斜体、下划线）
- 系统检查是否有选中的文本
- 如果没有选中文本，显示提示信息

### 3. 处理文本
- 提取选中文本内容
- 根据格式类型添加或移除HTML标签
- 替换原文本内容

### 4. 更新界面
- 更新文本框内容
- 调整选择范围
- 保持光标位置
- 聚焦到文本框

## 错误处理

### 选择验证
```typescript
if (!hasSelection.value) {
  ElMessage.warning('请先选择要格式化的文本')
  return
}
```

### 范围验证
```typescript
if (start < 0) start = 0
if (end > text.length) end = text.length
if (start >= end) return
```

### DOM元素验证
```typescript
const textarea = document.querySelector('textarea') as HTMLTextAreaElement
if (!textarea) return
```

## 性能优化

### 1. 使用nextTick
确保DOM更新完成后再操作选择范围，避免时序问题。

### 2. 精确的文本操作
只处理选中的文本，不影响其他内容。

### 3. 智能标签检测
避免重复添加标签，减少不必要的DOM操作。

## 兼容性考虑

### 1. HTML标签兼容
- 使用标准HTML标签：`<strong>`, `<em>`, `<u>`
- 支持标签的嵌套和组合

### 2. AI功能兼容
- AI功能可以处理包含HTML标签的文本
- 标签不会影响AI的文本分析

### 3. 浏览器兼容
- 使用标准的DOM API
- 支持主流浏览器

## 使用示例

### 基本格式化
1. 选中文本："这是示例文本"
2. 点击"加粗"按钮
3. 结果：`<strong>这是示例文本</strong>`

### 组合格式化
1. 选中文本："重要提示"
2. 依次点击"加粗"、"斜体"、"下划线"
3. 结果：`<strong><em><u>重要提示</u></em></strong>`

### 移除格式
1. 选中已格式化的文本：`<strong>加粗文本</strong>`
2. 再次点击"加粗"按钮
3. 结果：`加粗文本`（标签被移除）

### 清除所有格式
1. 选中包含多种格式的文本
2. 点击"清除格式"按钮
3. 结果：所有HTML标签被移除

## 未来改进方向

1. **更多格式选项**：添加删除线、上标、下标等
2. **样式预设**：提供常用的样式组合
3. **撤销/重做**：支持格式化的撤销操作
4. **批量操作**：支持多个文本块的批量格式化
5. **样式继承**：支持样式的继承和传播 