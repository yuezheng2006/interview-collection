# 多轮对话和流式返回实现说明

## 概述

本次更新为AI写作助手添加了多轮对话和流式返回功能，提升了用户体验和AI交互的连续性。

## 主要功能

### 1. 多轮对话支持

#### 后端实现
- **对话历史管理**: 为每个会话维护独立的对话历史
- **会话ID**: 使用唯一的会话ID标识不同的对话会话
- **历史限制**: 每个会话最多保存20轮对话，避免内存占用过大

#### 前端实现
- **对话界面**: 新增多轮对话弹窗，支持实时对话
- **历史显示**: 显示完整的对话历史，区分用户和AI消息
- **会话管理**: 支持清空对话历史，重新开始对话

### 2. 流式返回支持

#### 后端实现
- **SSE支持**: 使用Server-Sent Events实现流式数据传输
- **流式写入器**: 自定义StreamWriter处理流式响应
- **错误处理**: 流式传输过程中的错误处理和恢复

#### 前端实现
- **流式接收**: 使用Fetch API的ReadableStream处理流式数据
- **实时显示**: 支持AI回复的实时显示，提升用户体验
- **状态管理**: 流式传输过程中的加载状态和完成状态管理

## 技术实现

### 后端架构

#### 1. AI接口扩展
```go
// 新增流式AI调用接口
func (d *DeepSeekProvider) CallAIStream(ctx context.Context, function, content, sessionID string, writer io.Writer) error

// 新增多轮对话接口
func (d *DeepSeekProvider) Chat(ctx context.Context, message, sessionID string) (string, error)
```

#### 2. 对话历史管理
```go
type ConversationHistory struct {
    Messages []DeepSeekMessage
    MaxSize  int
}

func (ch *ConversationHistory) AddMessage(role, content string)
func (ch *ConversationHistory) GetMessages() []DeepSeekMessage
func (ch *ConversationHistory) Clear()
```

#### 3. 流式响应处理
```go
type StreamWriter struct {
    c *gin.Context
}

func (sw *StreamWriter) Write(p []byte) (n int, err error)
func (sw *StreamWriter) WriteError(message string)
```

### 前端架构

#### 1. 流式AI调用
```typescript
export async function callUnifiedAIStream(
  data: UnifiedAiRequest, 
  callback: StreamCallback
): Promise<void>
```

#### 2. 多轮对话接口
```typescript
export async function chat(data: ChatRequest): Promise<ChatResponse>
```

#### 3. 会话管理
```typescript
export function generateSessionID(): string
```

## API接口

### 1. 多轮对话接口
```
POST /ai/chat
Content-Type: application/json

{
  "message": "用户消息",
  "sessionID": "会话ID",
  "modelName": "模型名称"
}
```

### 2. 流式AI接口
```
POST /ai/unified
Content-Type: application/json

{
  "functionType": "功能类型",
  "stream": true,
  "sessionID": "会话ID",
  ...其他参数
}
```

响应头：
```
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
```

## 使用方式

### 1. 多轮对话
1. 点击"💬 多轮对话"按钮打开对话弹窗
2. 在输入框中输入问题或要求
3. 按Ctrl+Enter或点击"发送消息"按钮
4. 查看AI回复，继续对话
5. 可随时清空对话历史重新开始

### 2. 流式AI功能
1. 选择文本，点击AI功能按钮（润色、总结、续写等）
2. 系统自动启用流式返回
3. AI回复会实时显示，提升用户体验
4. 支持采纳或拒绝AI结果

## 兼容性说明

### 1. 模型支持
- **DeepSeek**: 完全支持多轮对话和流式返回
- **通义千问**: 暂不支持流式返回，使用非流式模拟
- **文心一言**: 暂不支持流式返回，使用非流式模拟
- **Mock**: 支持流式返回和多轮对话（模拟）

### 2. 向后兼容
- 原有的非流式AI接口保持不变
- 新增的流式功能为可选功能
- 会话ID为可选参数，不影响现有功能

## 性能优化

### 1. 内存管理
- 对话历史限制在20轮以内
- 自动清理过期的对话会话
- 流式传输避免大块数据占用内存

### 2. 网络优化
- 使用SSE减少HTTP连接开销
- 流式传输支持断点续传
- 错误重试机制

## 安全考虑

### 1. 会话隔离
- 每个用户/文档使用独立的会话ID
- 会话数据不跨用户共享
- 支持会话过期和清理

### 2. 输入验证
- 消息长度限制
- 内容类型验证
- 防止恶意输入

## 未来扩展

### 1. 功能增强
- 支持图片和文件上传
- 多模态AI交互
- 语音输入和输出

### 2. 性能提升
- WebSocket支持
- 消息压缩
- 缓存优化

### 3. 用户体验
- 对话模板
- 智能建议
- 个性化设置

## 总结

本次更新成功实现了多轮对话和流式返回功能，显著提升了AI写作助手的用户体验。通过合理的架构设计和兼容性考虑，确保了系统的稳定性和可扩展性。这些功能为后续的功能扩展奠定了良好的基础。 