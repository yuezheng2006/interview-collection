# 流式请求404问题排查指南

## 问题描述

前端流式AI请求报错：404，地址显示为 `editor/undefined/ai/unified`

## 问题分析

### 1. URL构建问题
- 前端使用了 `import.meta.env.VITE_API_BASE_URL`，但该环境变量未设置
- 导致URL变成了 `undefined/ai/unified`
- 最终请求路径变成了 `editor/undefined/ai/unified`

### 2. 代理配置问题
- Vite配置了代理：`/api` → `http://localhost:8080`
- 但流式请求没有使用正确的代理路径

## 解决方案

### 方案1：修复前端URL构建（推荐）

已修复：在 `frontend/src/services/ai.ts` 中，将流式请求URL改为：
```typescript
const apiUrl = '/api/ai/unified'
```

这样请求会通过Vite代理正确转发到后端。

### 方案2：设置环境变量

创建 `frontend/.env.local` 文件：
```bash
VITE_API_BASE_URL=/api
```

### 方案3：使用相对路径

确保所有API请求都使用相对路径，让Vite代理处理。

## 验证步骤

### 1. 检查前端开发服务器
```bash
cd frontend
npm run dev
```

确保看到类似输出：
```
  VITE v7.0.6  ready in 500 ms

  ➜  Local:   http://localhost:3000/
  ➜  Network: use --host to expose
  ➜  press h to show help
```

### 2. 检查后端服务
```bash
cd backend
go run cmd/server/main.go
```

确保看到类似输出：
```
[GIN] Listening and serving HTTP on :8080
```

### 3. 检查网络请求

在浏览器开发者工具的Network标签中：
1. 发起流式AI请求
2. 查看请求URL是否正确：`/api/ai/unified`
3. 查看请求是否被代理到后端

### 4. 检查代理配置

在 `frontend/vite.config.ts` 中确认：
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true,
    },
  },
},
```

## 常见问题

### 1. 前端服务器未启动
- 确保在 `frontend` 目录下运行 `npm run dev`
- 检查端口3000是否被占用

### 2. 后端服务器未启动
- 确保在 `backend` 目录下运行后端服务
- 检查端口8080是否被占用

### 3. 代理配置错误
- 确保 `vite.config.ts` 中的代理配置正确
- 重启前端开发服务器

### 4. 环境变量问题
- 检查是否有 `.env` 文件覆盖了配置
- 确保环境变量名称正确

## 调试技巧

### 1. 浏览器控制台
查看是否有错误信息：
```javascript
console.log('API URL:', apiUrl)
console.log('Request data:', data)
```

### 2. 网络面板
- 查看请求的完整URL
- 检查请求头和响应
- 确认代理是否工作

### 3. 后端日志
查看后端是否收到请求：
```go
log.Printf("Received request: %s %s", c.Request.Method, c.Request.URL.Path)
```

## 预期结果

修复后，流式请求应该：
1. 使用正确的URL：`/api/ai/unified`
2. 通过Vite代理转发到后端
3. 后端正确处理流式请求
4. 前端实时显示AI回复

## 如果问题仍然存在

### 1. 检查路由注册
确保后端正确注册了 `/ai/unified` 路由：
```go
func registerAIRoutes(g *gin.RouterGroup) {
    // ... 其他路由
    g.POST("/ai/unified", func(c *gin.Context) {
        // 处理逻辑
    })
}
```

### 2. 检查中间件
确保没有中间件阻止了请求：
```go
protected := api.Group("")
protected.Use(requireAuth())  // 检查认证中间件
registerAIRoutes(protected)
```

### 3. 检查CORS
确保后端允许前端域名的请求：
```go
r.Use(cors.New(cors.Config{
    AllowOrigins: []string{"http://localhost:3000"},
    AllowMethods: []string{"GET", "POST", "PUT", "DELETE"},
    AllowHeaders: []string{"Origin", "Content-Type", "Authorization"},
}))
```

## 总结

404错误通常是由于：
1. 前端URL构建错误
2. 代理配置问题
3. 后端路由未正确注册
4. 中间件阻止了请求

按照上述步骤逐一排查，应该能够解决问题。 