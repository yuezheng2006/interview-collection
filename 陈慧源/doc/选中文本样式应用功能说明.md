# 选中文本样式应用功能说明

## 功能概述

实现了智能的文本样式应用系统，支持将字体大小和颜色应用到选中的文本，同时保持文本选择状态，解决了传统实现中点击样式控件后文本选择丢失的问题。

## 核心特性

### 1. 智能样式应用
- **选中文本**：字体大小和颜色只应用到选中的文本部分，不修改整个编辑器
- **未选中文本**：字体大小和颜色应用到整个编辑器
- **自动检测**：智能识别当前是否有选中的文本
- **互斥应用**：确保不会同时应用到选中部分和整个编辑器

### 2. 选择状态保持
- 应用样式后自动恢复文本选择状态
- 保持光标位置和选择范围
- 自动聚焦到文本框，继续编辑

### 3. 标签管理
- 智能检测已存在的样式标签
- 避免重复添加相同标签
- 支持标签的更新和替换

## 技术实现

### 1. 智能检测逻辑
```typescript
function handleFontSizeChange() {
  // 如果有选中的文本，应用字体大小到选中部分
  if (hasSelection.value && selectionStart.value >= 0 && selectionEnd.value > selectionStart.value) {
    applyFontSizeToSelection()
  } else {
    // 没有选中文本时，应用到整个编辑器
    applyFontSizeToEditor()
  }
}
```

### 2. 选中文本样式应用
```typescript
function applyFontSizeToSelection() {
  const textarea = document.querySelector('textarea') as HTMLTextAreaElement
  if (!textarea) return

  const text = content.value
  let start = selectionStart.value
  let end = selectionEnd.value

  // 确保选择范围在文本内
  if (start < 0) start = 0
  if (end > text.length) end = text.length
  if (start >= end) return

  // 提取选中文本
  const selectedText = text.substring(start, end)
  
  // 检查是否已经有字体大小标签
  let formattedText = selectedText
  
  if (selectedText.includes('<span style="font-size:')) {
    // 更新现有的字体大小
    formattedText = selectedText.replace(
      /<span style="font-size:[^"]*">([^<]*)<\/span>/g,
      `<span style="font-size:${fontSize.value}">$1</span>`
    )
  } else {
    // 添加字体大小标签
    formattedText = `<span style="font-size:${fontSize.value}">${selectedText}</span>`
  }

  // 替换选中文本
  const newText = text.substring(0, start) + formattedText + text.substring(end)
  
  // 更新内容
  content.value = newText
  
  // 更新选择范围
  const newStart = start
  const newEnd = start + formattedText.length
  
  // 使用nextTick确保DOM更新后再设置选择范围
  nextTick(() => {
    if (textarea) {
      textarea.setSelectionRange(newStart, newEnd)
      selectionStart.value = newStart
      selectionEnd.value = newEnd
      cursorPosition.value = newEnd
      textarea.focus()
    }
  })
}
```

### 3. 标签检测和更新
```typescript
// 字体大小标签检测
if (selectedText.includes('<span style="font-size:')) {
  // 更新现有的字体大小
  formattedText = selectedText.replace(
    /<span style="font-size:[^"]*">([^<]*)<\/span>/g,
    `<span style="font-size:${fontSize.value}">$1</span>`
  )
} else {
  // 添加字体大小标签
  formattedText = `<span style="font-size:${fontSize.value}">${selectedText}</span>`
}

// 字体颜色标签检测
if (selectedText.includes('<span style="color:')) {
  // 更新现有的字体颜色
  formattedText = selectedText.replace(
    /<span style="color:[^"]*">([^<]*)<\/span>/g,
    `<span style="color:${fontColor.value}">$1</span>`
  )
} else {
  // 添加字体颜色标签
  formattedText = `<span style="color:${fontColor.value}">${selectedText}</span>`
}
```

## 用户交互流程

### 1. 选中文本应用样式
1. 用户选择要应用样式的文本
2. 选择字体大小或颜色
3. 系统检测到有选中的文本
4. 应用样式到选中的文本部分
5. 保持文本选择状态
6. 自动聚焦到文本框

### 2. 整体编辑器应用样式
1. 用户没有选中任何文本
2. 选择字体大小或颜色
3. 系统检测到没有选中的文本
4. 应用样式到整个编辑器
5. 更新编辑器显示
6. 编辑器全局样式发生变化

### 3. 样式标签更新
1. 用户选择已应用样式的文本
2. 选择新的样式值
3. 系统检测到现有的样式标签
4. 更新标签中的样式值
5. 保持文本选择状态

## 支持的样式类型

### 1. 字体大小
- **标签格式**：`<span style="font-size:16px">文本</span>`
- **支持值**：12px, 14px, 16px, 18px, 20px, 24px, 28px, 32px
- **智能更新**：检测现有标签并更新大小值

### 2. 字体颜色
- **标签格式**：`<span style="color:#ff0000">文本</span>`
- **支持值**：任意十六进制颜色值
- **智能更新**：检测现有标签并更新颜色值

### 3. 样式组合
- 支持字体大小和颜色的组合应用
- 支持与加粗、斜体、下划线的组合
- 正确处理嵌套标签和复杂结构

## 选择状态管理

### 1. 选择范围保持
```typescript
// 更新选择范围
const newStart = start
const newEnd = start + formattedText.length

// 使用nextTick确保DOM更新后再设置选择范围
nextTick(() => {
  if (textarea) {
    textarea.setSelectionRange(newStart, newEnd)
    selectionStart.value = newStart
    selectionEnd.value = newEnd
    cursorPosition.value = newEnd
    textarea.focus()
  }
})
```

### 2. 状态同步
- 实时同步选择范围状态
- 保持光标位置信息
- 自动更新选择状态变量

### 3. 焦点管理
- 样式应用后自动聚焦到文本框
- 保持用户的编辑连续性
- 提升用户体验

## 错误处理和边界情况

### 1. 选择范围验证
```typescript
// 确保选择范围在文本内
if (start < 0) start = 0
if (end > text.length) end = text.length
if (start >= end) return
```

### 2. DOM元素验证
```typescript
const textarea = document.querySelector('textarea') as HTMLTextAreaElement
if (!textarea) return
```

### 3. 异步更新处理
- 使用nextTick确保DOM更新完成
- 避免时序问题和状态不一致
- 保证操作的可靠性

## 性能优化

### 1. 条件执行
- 只在必要时执行样式应用逻辑
- 避免不必要的DOM操作
- 减少计算开销

### 2. 批量更新
- 一次性更新文本内容
- 减少DOM重绘次数
- 提升操作性能

### 3. 状态缓存
- 缓存选择范围信息
- 避免重复计算
- 优化响应速度

## 兼容性考虑

### 1. 浏览器支持
- 使用标准的DOM API
- 支持主流浏览器
- 优雅降级处理

### 2. HTML标签兼容
- 使用标准的HTML标签
- 支持样式属性的组合
- 避免使用过时标签

### 3. 编辑器兼容
- 与现有编辑器功能完全兼容
- 不影响AI功能的使用
- 保持功能完整性

## 使用示例

### 1. 基本字体大小应用
1. 选择文本："重要提示"
2. 选择字体大小：20px
3. 结果：`<span style="font-size:20px">重要提示</span>`
4. 文本保持选中状态，可继续编辑

### 2. 字体颜色应用
1. 选择文本："警告信息"
2. 选择颜色：#ff0000（红色）
3. 结果：`<span style="color:#ff0000">警告信息</span>`
4. 文本保持选中状态，可继续编辑

### 3. 样式更新
1. 选择已应用样式的文本：`<span style="font-size:16px">文本</span>`
2. 选择新的字体大小：24px
3. 结果：`<span style="font-size:24px">文本</span>`
4. 标签被更新，文本保持选中

### 4. 组合样式应用
1. 选择文本："标题"
2. 应用加粗：`<strong>标题</strong>`
3. 应用字体大小：`<span style="font-size:24px"><strong>标题</strong></span>`
4. 应用颜色：`<span style="color:#0000ff"><span style="font-size:24px"><strong>标题</strong></span></span>`

## 未来改进方向

### 1. 样式预设
- 提供常用的样式组合
- 支持用户自定义样式
- 快速应用样式模板

### 2. 样式继承
- 支持样式的继承和传播
- 实现样式的一致性管理
- 支持样式规则的批量应用

### 3. 撤销/重做
- 支持样式操作的撤销
- 记录样式应用历史
- 提供操作回滚功能

### 4. 样式管理
- 样式库管理
- 样式导入导出
- 样式版本控制 