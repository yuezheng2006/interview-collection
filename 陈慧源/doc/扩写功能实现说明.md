# 扩写功能实现说明

## 功能概述

扩写功能是AI写作助手的核心功能之一，允许用户基于选中的文本内容，通过AI进行内容扩展和丰富，增加更多细节和内容。

## 功能特点

- **智能扩写**：基于选中文本和上下文进行智能扩写
- **风格一致**：保持与原文风格和语调的一致性
- **流式返回**：支持实时显示AI生成内容
- **多模型支持**：支持通义千问、文心一言、DeepSeek等多种AI模型

## 技术实现

### 前端实现

#### 1. 扩写按钮
```vue
<el-button
  type="info"
  size="small"
  :loading="isAiProcessing"
  @click="handleAiFunction('expand')"
  :disabled="!hasSelection"
>
  🔍 扩写
</el-button>
```

#### 2. 功能类型定义
```typescript
// 在 types/index.ts 中定义
export type AiFunctionType = 'continue' | 'polish' | 'summarize' | 'generate' | 'expand'
```

#### 3. 默认提示词
```typescript
// 在 Editor.vue 中定义
expand: '请帮我扩写这段文字，增加更多细节和内容'
```

#### 4. AI调用流程
```typescript
async function callAI() {
  // ... 前置检查
  
  const requestData: UnifiedAiRequest = {
    functionType: 'expand', // 扩写功能类型
    documentSummary: generateDocumentSummary(content.value),
    userRequirement: userRequirement.value,
    selectedText: smartSelection?.text || '',
    contextText: smartSelection ? `${smartSelection.contextBefore}${smartSelection.text}${smartSelection.contextAfter}` : '',
    cursorPosition: cursorPosition.value,
    modelName: currentModel.value,
    sessionID: sessionID.value,
    stream: true
  }
  
  // 调用流式AI接口
  await callUnifiedAIStream(requestData, handleStreamCallback)
}
```

### 后端实现

#### 1. 统一AI接口支持
```go
// 在 handler/ai.go 中添加扩写功能支持
case "expand":
    prompt = buildExpandPrompt(req.UserRequirement, req.SelectedText, req.ContextText)
```

#### 2. 扩写提示词构建
```go
// 构建扩写提示词
func buildExpandPrompt(userRequirement, selectedText, contextText string) string {
    return "用户要求：" + userRequirement + "\n\n" +
           "原文：" + selectedText + "\n\n" +
           "上下文内容：" + contextText + "\n\n" +
           "请基于以上信息，保持风格一致地扩写内容。"
}
```

#### 3. 流式和非流式处理
```go
// 流式处理
case "expand":
    prompt := buildExpandPrompt(req.UserRequirement, req.SelectedText, req.ContextText)
    err := currentProvider.CallAIStream(context.Background(), req.FunctionType, prompt, req.SessionID, streamWriter)

// 非流式处理
case "expand":
    prompt := buildExpandPrompt(req.UserRequirement, req.SelectedText, req.ContextText)
    result, err = currentProvider.ContinueWriting(context.Background(), prompt)
```

## 使用流程

1. **选择文本**：用户在编辑器中选中需要扩写的文本
2. **点击扩写**：点击扩写按钮，打开AI功能弹窗
3. **设置要求**：输入具体的扩写要求（可选，有默认提示词）
4. **选择模型**：选择要使用的AI模型
5. **开始处理**：点击"开始AI处理"按钮
6. **实时显示**：AI开始流式生成内容，实时显示在弹窗中
7. **结果处理**：用户可以选择采纳或拒绝AI生成的结果

## 技术架构

### 数据流
```
前端选择文本 → 构建请求参数 → 调用后端API → AI模型处理 → 流式返回结果 → 前端实时显示
```

### 关键组件
- **前端**：Editor.vue（编辑器组件）、AI弹窗、流式内容显示
- **后端**：统一AI接口、扩写提示词构建、流式响应处理
- **AI服务**：多种AI模型提供者、流式调用接口

## 配置要求

### 环境变量
确保配置了相应AI模型的API密钥：
- 通义千问：`TONGYI_API_KEY`
- 文心一言：`WENXIN_API_KEY`、`WENXIN_SECRET_KEY`
- DeepSeek：`DEEPSEEK_API_KEY`

### 模型配置
在 `configs/config.yaml` 中配置默认AI模型：
```yaml
ai:
  defaultModel: "tongyi"  # 或其他可用模型
```

## 测试验证

### 功能测试
1. 选择一段文本，点击扩写按钮
2. 验证AI弹窗正常打开
3. 验证流式内容正常显示
4. 验证结果可以正常采纳或拒绝

### 错误处理测试
1. 测试无选中文本时的提示
2. 测试AI服务不可用时的错误处理
3. 测试网络异常时的错误处理

## 扩展性

扩写功能设计具有良好的扩展性：
- 支持多种AI模型
- 支持流式和非流式两种模式
- 提示词模板可配置
- 支持自定义扩写要求

## 注意事项

1. **文本选择**：扩写功能需要用户先选择文本内容
2. **模型可用性**：确保选择的AI模型处于可用状态
3. **流式处理**：扩写功能默认启用流式返回，提供更好的用户体验
4. **错误处理**：完善的错误处理机制，确保用户操作的稳定性 