# 配置文件加载问题解决方案

## 问题描述

在开发AI写作助手项目时，遇到了配置文件无法正常加载的问题，主要表现为：

1. 配置文件路径找不到
2. YAML解析失败
3. 环境变量替换问题

## 问题分析

### 1. 文件路径问题

**原因**：使用相对路径 `"configs/config.yaml"` 时，路径是相对于程序运行时的当前工作目录，而不是相对于代码文件的位置。

**解决方案**：
- 实现多路径尝试机制
- 支持从可执行文件所在目录查找
- 提供详细的错误日志

### 2. YAML格式问题

**原因**：
- 中文字符注释可能导致编码问题
- 缩进不一致（制表符vs空格）
- 隐藏字符污染

**解决方案**：
- 使用纯英文注释
- 确保缩进使用空格（2个空格）
- 重新创建干净的配置文件

### 3. 环境变量替换问题

**原因**：当环境变量为空时，替换函数使用 `""` 替换占位符，导致YAML语法错误。

**解决方案**：
- 空环境变量时使用空字符串（不带引号）
- 改进错误处理和日志记录

## 修复后的代码结构

### 配置加载函数

```go
func loadYAMLConfig() *AIConfig {
    // 尝试多个可能的配置文件路径
    configPaths := []string{
        "configs/config.yaml",                    // 相对于当前工作目录
        "../configs/config.yaml",                 // 相对于当前工作目录的上级
        "../../configs/config.yaml",              // 相对于当前工作目录的上上级
        "./configs/config.yaml",                  // 明确当前目录
    }
    
    // 如果所有路径都失败，尝试从可执行文件所在目录查找
    if configData == nil {
        execPath, execErr := os.Executable()
        if execErr == nil {
            execDir := filepath.Dir(execPath)
            execConfigPath := filepath.Join(execDir, "configs", "config.yaml")
            configData, err = os.ReadFile(execConfigPath)
            if err == nil {
                configPath = execConfigPath
            }
        }
    }
    
    // 详细的错误日志
    if err := yaml.Unmarshal(configData, &config); err != nil {
        fmt.Printf("错误: 解析配置文件失败: %v\n", err)
        fmt.Printf("配置文件内容:\n%s\n", string(configData))
        return nil
    }
    
    return &config
}
```

### 环境变量替换函数

```go
func replaceEnvPlaceholders(data []byte) []byte {
    content := string(data)
    
    replacements := map[string]string{
        "${TONGYI_API_KEY}":    os.Getenv("TONGYI_API_KEY"),
        "${DEEPSEEK_API_KEY}":  os.Getenv("DEEPSEEK_API_KEY"),
        "${WENXIN_API_KEY}":    os.Getenv("WENXIN_API_KEY"),
        "${ZHIPU_API_KEY}":     os.Getenv("ZHIPU_API_KEY"),
        // ... 其他环境变量
    }
    
    for placeholder, value := range replacements {
        if value == "" {
            // 空环境变量时使用空字符串（不带引号）
            content = strings.ReplaceAll(content, placeholder, "")
        } else {
            content = strings.ReplaceAll(content, placeholder, value)
        }
    }
    
    return []byte(content)
}
```

## 最佳实践

### 1. 配置文件管理

- 使用纯英文注释避免编码问题
- 确保缩进使用空格（2个空格）
- 避免使用制表符
- 定期验证YAML语法

### 2. 路径处理

- 实现多路径回退机制
- 支持相对路径和绝对路径
- 提供详细的路径查找日志
- 考虑不同运行环境（开发、测试、生产）

### 3. 环境变量

- 使用占位符语法 `${VAR_NAME}`
- 正确处理空环境变量
- 提供默认值机制
- 环境变量优先级高于配置文件

### 4. 错误处理

- 提供详细的错误信息
- 实现优雅的降级机制
- 记录配置文件加载过程
- 支持调试模式

## 测试验证

修复后的配置加载功能已经通过测试验证：

```bash
go run test_config.go
```

输出结果：
```
=== 测试配置文件加载 ===
成功加载配置文件: configs/config.yaml
默认模型: wenxin
文心一言配置:
  API Key: bce-v3/A***
  Base URL: https://qianfan.baidubce.com/v2/chat/completions
  Model: am-xpgukxjf6s0r
  Max Tokens: 16384
  Temperature: 0.70
...
=== 配置加载测试完成 ===
```

## 总结

通过以上修复，配置文件加载问题已经解决：

1. ✅ 配置文件路径问题已解决
2. ✅ YAML格式问题已解决  
3. ✅ 环境变量替换问题已解决
4. ✅ 配置加载功能正常工作
5. ✅ 提供了详细的错误日志和调试信息

现在AI写作助手项目可以正常加载配置文件，支持多种AI模型的配置管理。 